# ç«¯å£è¿‡æ»¤è„šæœ¬ - IPç™½åå•ç‰ˆæœ¬

## ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨ç«¯å£è®¿é—®æŽ§åˆ¶è„šæœ¬ï¼Œåœ¨åŽŸæœ‰åŸºç¡€ä¸Šå¢žåŠ äº†IPç™½åå•åŠŸèƒ½ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…è¯¯æ‹¦æˆªé—®é¢˜ã€‚

## æ–°å¢žåŠŸèƒ½

### ðŸŽ¯ IPç™½åå•åŠŸèƒ½
- **å•ä¸ªIPç™½åå•**ï¼šæ”¯æŒæ·»åŠ å•ä¸ªIPv4/IPv6åœ°å€
- **IPæ®µç™½åå•**ï¼šæ”¯æŒCIDRæ ¼å¼çš„IPæ®µç™½åå•
- **ä¼˜å…ˆçº§æŽ§åˆ¶**ï¼šç™½åå•ä¼˜å…ˆçº§é«˜äºŽåœ°åŸŸè¿‡æ»¤è§„åˆ™
- **åŠ¨æ€ç®¡ç†**ï¼šæ”¯æŒå®žæ—¶æ·»åŠ ã€åˆ é™¤ã€æŸ¥çœ‹ç™½åå•
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šç™½åå•é…ç½®è‡ªåŠ¨ä¿å­˜ï¼Œé‡å¯åŽä»ç„¶æœ‰æ•ˆ

### ðŸ”§ ç™½åå•ç®¡ç†
- **äº¤äº’å¼ç®¡ç†**ï¼šé€šè¿‡èœå•è½»æ¾ç®¡ç†ç™½åå•
- **æ‰¹é‡å¯¼å…¥**ï¼šæ”¯æŒä»Žæ–‡ä»¶æ‰¹é‡å¯¼å…¥IPç™½åå•
- **è¯¦ç»†è®°å½•**ï¼šæ¯ä¸ªç™½åå•IPéƒ½å¯ä»¥æ·»åŠ å¤‡æ³¨ä¿¡æ¯
- **çŠ¶æ€æŸ¥çœ‹**ï¼šå®žæ—¶æŸ¥çœ‹å½“å‰ç™½åå•çŠ¶æ€å’Œç»Ÿè®¡

## ä½¿ç”¨åœºæ™¯

### å¸¸è§ä½¿ç”¨åœºæ™¯
1. **å†…ç½‘æœåŠ¡å™¨**ï¼šå°†å†…ç½‘IPæ®µåŠ å…¥ç™½åå•ï¼Œé¿å…è¢«åœ°åŸŸè§„åˆ™è¯¯æ‹¦æˆª
2. **åˆä½œä¼™ä¼´**ï¼šå°†åˆä½œä¼™ä¼´çš„IPåœ°å€åŠ å…¥ç™½åå•ï¼Œç¡®ä¿ä¸šåŠ¡æ­£å¸¸
3. **ç®¡ç†å‘˜è®¿é—®**ï¼šå°†ç®¡ç†å‘˜IPåŠ å…¥ç™½åå•ï¼Œç¡®ä¿ç®¡ç†é€šé“ç•…é€š
4. **é‡è¦å®¢æˆ·**ï¼šå°†é‡è¦å®¢æˆ·çš„IPåŠ å…¥ç™½åå•ï¼Œæä¾›ä¼˜å…ˆæœåŠ¡
5. **ç›‘æŽ§æœåŠ¡**ï¼šå°†ç›‘æŽ§æœåŠ¡å™¨IPåŠ å…¥ç™½åå•ï¼Œç¡®ä¿ç›‘æŽ§æ­£å¸¸

### ç™½åå•ä¼˜å…ˆçº§
```
è§„åˆ™ä¼˜å…ˆçº§ï¼ˆä»Žé«˜åˆ°ä½Žï¼‰ï¼š
1. IPç™½åå•ï¼ˆACCEPTï¼‰- æœ€é«˜ä¼˜å…ˆçº§
2. åœ°åŸŸé»‘åå•ï¼ˆDROPï¼‰
3. åœ°åŸŸç™½åå•ï¼ˆACCEPTï¼‰
4. ç«¯å£å±è”½ï¼ˆDROPï¼‰
5. ç«¯å£æ”¾è¡Œï¼ˆACCEPTï¼‰- æœ€ä½Žä¼˜å…ˆçº§
```

## å®‰è£…ä½¿ç”¨

### å¿«é€Ÿå¼€å§‹
```bash
# ä¸‹è½½è„šæœ¬
wget https://github.com/wxhdrsa7/port-filter-script/raw/main/port-filter-with-whitelist.sh

# è®¾ç½®æƒé™
chmod +x port-filter-with-whitelist.sh

# è¿è¡Œè„šæœ¬
sudo ./port-filter-with-whitelist.sh
```

### å‘½ä»¤è¡Œå‚æ•°
```bash
# æ›´æ–°IPåˆ—è¡¨
sudo ./port-filter-with-whitelist.sh --update-ip

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
sudo ./port-filter-with-whitelist.sh --status

# åˆ›å»ºå¤‡ä»½
sudo ./port-filter-with-whitelist.sh --backup

# æ˜¾ç¤ºå¸®åŠ©
sudo ./port-filter-with-whitelist.sh --help
```

## ç™½åå•ç®¡ç†

### ä¸»èœå•æ“ä½œ
é€‰æ‹©èœå•é¡¹ `10. IPç™½åå•ç®¡ç†` è¿›å…¥ç™½åå•ç®¡ç†ç•Œé¢

### ç™½åå•ç®¡ç†èœå•
1. **æ·»åŠ IPç™½åå•** - æ·»åŠ å•ä¸ªIPåœ°å€æˆ–IPæ®µ
2. **ç§»é™¤IPç™½åå•** - åˆ é™¤æŒ‡å®šçš„IPç™½åå•
3. **æŸ¥çœ‹IPç™½åå•** - æ˜¾ç¤ºå½“å‰æ‰€æœ‰ç™½åå•IP
4. **æ¸…ç©ºIPç™½åå•** - åˆ é™¤æ‰€æœ‰ç™½åå•IPï¼ˆè°¨æ…Žæ“ä½œï¼‰
5. **ä»Žæ–‡ä»¶å¯¼å…¥ç™½åå•** - æ‰¹é‡å¯¼å…¥IPç™½åå•
0. **è¿”å›žä¸»èœå•** - è¿”å›žä¸»ç¨‹åºç•Œé¢

### æ·»åŠ IPç™½åå•
```bash
é€‰æ‹©èœå•: 10    # è¿›å…¥ç™½åå•ç®¡ç†
é€‰æ‹©èœå•: 1     # æ·»åŠ IPç™½åå•
è¯·è¾“å…¥IPåœ°å€æˆ–IPæ®µ (æ”¯æŒ192.168.1.1æˆ–192.168.1.0/24æ ¼å¼): 192.168.1.100
è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ (å¯é€‰): å†…ç½‘æœåŠ¡å™¨1
ç¡®è®¤æ“ä½œ: y
```

### æ”¯æŒçš„IPæ ¼å¼
- **å•ä¸ªIPv4åœ°å€**ï¼š`192.168.1.100`
- **IPv4åœ°å€æ®µ**ï¼š`192.168.1.0/24`
- **å•ä¸ªIPv6åœ°å€**ï¼š`2001:db8::1`
- **IPv6åœ°å€æ®µ**ï¼š`2001:db8::/64`

### æ‰¹é‡å¯¼å…¥ç™½åå•
1. åˆ›å»ºåŒ…å«IPåˆ—è¡¨çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªIPåœ°å€
```bash
# åˆ›å»ºç™½åå•æ–‡ä»¶
cat > /tmp/whitelist-ips.txt << 'EOF'
192.168.1.10 æœåŠ¡å™¨1
192.168.1.20 æœåŠ¡å™¨2
10.0.0.0/24 å†…ç½‘ç½‘æ®µ
2001:db8::10 IPv6æœåŠ¡å™¨
EOF
```

2. åœ¨è„šæœ¬ä¸­é€‰æ‹©æ‰¹é‡å¯¼å…¥åŠŸèƒ½
```bash
é€‰æ‹©èœå•: 10    # è¿›å…¥ç™½åå•ç®¡ç†
é€‰æ‹©èœå•: 5     # ä»Žæ–‡ä»¶å¯¼å…¥ç™½åå•
è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: /tmp/whitelist-ips.txt
```

## é…ç½®ç¤ºä¾‹

### å…¸åž‹é…ç½®åœºæ™¯

#### åœºæ™¯1ï¼šå†…ç½‘æœåŠ¡å™¨è®¿é—®å¤–ç½‘API
```bash
# 1. è®¾ç½®APIç«¯å£çš„åœ°åŸŸè¿‡æ»¤ï¼ˆåªå…è®¸å›½å¤–è®¿é—®ï¼‰
ç«¯å£: 8080
åè®®: TCP
æ¨¡å¼: é»‘åå•ï¼ˆé˜»æ­¢ä¸­å›½IPï¼‰

# 2. æ·»åŠ å†…ç½‘æœåŠ¡å™¨åˆ°ç™½åå•
IP: 192.168.1.0/24
å¤‡æ³¨: å†…ç½‘æœåŠ¡å™¨ç½‘æ®µ
```

#### åœºæ™¯2ï¼šåˆä½œä¼™ä¼´ç‰¹æ®Šè®¿é—®æƒé™
```bash
# 1. è®¾ç½®ç«¯å£å±è”½ï¼ˆé»˜è®¤ä¸å…è®¸è®¿é—®ï¼‰
ç«¯å£: 3306
åè®®: TCP
æ“ä½œ: å±è”½ç«¯å£

# 2. æ·»åŠ åˆä½œä¼™ä¼´IPåˆ°ç™½åå•
IP: 203.0.113.50
å¤‡æ³¨: åˆä½œä¼™ä¼´æ•°æ®åº“è®¿é—®
```

#### åœºæ™¯3ï¼šç®¡ç†å‘˜ä¸å—é™åˆ¶è®¿é—®
```bash
# 1. è®¾ç½®ä¸¥æ ¼çš„åœ°åŸŸè¿‡æ»¤
ç«¯å£: 22
åè®®: TCP
æ¨¡å¼: ç™½åå•ï¼ˆä»…å…è®¸ä¸­å›½IPï¼‰

# 2. æ·»åŠ ç®¡ç†å‘˜IPåˆ°ç™½åå•
IP: 198.51.100.10
å¤‡æ³¨: ç®¡ç†å‘˜IPï¼ˆä¸å—åœ°åŸŸé™åˆ¶ï¼‰
```

## é…ç½®æ–‡ä»¶

### ç™½åå•é…ç½®æ–‡ä»¶
- **æ–‡ä»¶è·¯å¾„**ï¼š`/etc/port-filter/whitelist.conf`
- **æ ¼å¼è¯´æ˜Ž**ï¼šæ¯è¡Œä¸€ä¸ªIPï¼Œæ ¼å¼ä¸º `IPåœ°å€|å¤‡æ³¨ä¿¡æ¯`
- **æƒé™è®¾ç½®**ï¼š600ï¼ˆä»…rootå¯è¯»å†™ï¼‰

### ç¤ºä¾‹é…ç½®
```bash
# /etc/port-filter/whitelist.conf
192.168.1.100|å†…ç½‘ä¸»æœåŠ¡å™¨
192.168.1.101|å†…ç½‘å¤‡ä»½æœåŠ¡å™¨
10.0.0.0/24|åŠžå…¬ç½‘ç»œ
2001:db8::10|IPv6æµ‹è¯•æœåŠ¡å™¨
203.0.113.50|åˆä½œä¼™ä¼´IP
```

## é«˜çº§åŠŸèƒ½

### ç™½åå•ç»Ÿè®¡ä¿¡æ¯
åœ¨ç³»ç»ŸçŠ¶æ€æŸ¥çœ‹ä¸­å¯ä»¥èŽ·å–ç™½åå•ç»Ÿè®¡ï¼š
```bash
sudo ./port-filter-with-whitelist.sh --status
```

æ˜¾ç¤ºå†…å®¹åŒ…æ‹¬ï¼š
- IPv4ç™½åå•æ•°é‡
- IPv6ç™½åå•æ•°é‡
- ç™½åå•è§„åˆ™ä¼˜å…ˆçº§çŠ¶æ€
- æ¯ä¸ªç™½åå•IPçš„å‘½ä¸­ç»Ÿè®¡

### ç™½åå•å¤‡ä»½
```bash
# åˆ›å»ºåŒ…å«ç™½åå•çš„å®Œæ•´å¤‡ä»½
sudo ./port-filter-with-whitelist.sh --backup

# å¤‡ä»½æ–‡ä»¶åŒ…å«ï¼š
# - ç«¯å£è¿‡æ»¤è§„åˆ™
# - IPç™½åå•é…ç½®
# - ç³»ç»Ÿè®¾ç½®
# - iptablesè§„åˆ™
```

### ç™½åå•æ—¥å¿—
```bash
# æŸ¥çœ‹ç™½åå•ç›¸å…³æ—¥å¿—
tail -f /var/log/port-filter/update.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/port-filter/error.log
```

## æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

#### ç™½åå•ä¸ç”Ÿæ•ˆ
```bash
# æ£€æŸ¥ç™½åå•IPSetæ˜¯å¦å­˜åœ¨
ipset list whitelist

# æ£€æŸ¥iptablesè§„åˆ™
iptables -L INPUT -n | grep whitelist

# éªŒè¯IPåœ°å€æ ¼å¼
validate_ip_func() {
    local ip="$1"
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$ ]]; then
        echo "æœ‰æ•ˆIPv4åœ°å€"
        return 0
    elif [[ "$ip" =~ ^([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}(/[0-9]+)?$ ]]; then
        echo "æœ‰æ•ˆIPv6åœ°å€"
        return 0
    else
        echo "æ— æ•ˆIPåœ°å€æ ¼å¼"
        return 1
    fi
}
```

#### ç™½åå•IPè¢«æ‹¦æˆª
```bash
# æ£€æŸ¥è§„åˆ™é¡ºåº
iptables -L INPUT -n --line-numbers | grep -E "(whitelist|DROP|ACCEPT)"

# ç¡®ä¿ç™½åå•è§„åˆ™åœ¨æœ€å‰é¢
# ç™½åå•è§„åˆ™åº”è¯¥å‡ºçŽ°åœ¨å…¶ä»–é™åˆ¶è§„åˆ™ä¹‹å‰
```

#### ç™½åå•é…ç½®ä¸¢å¤±
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /etc/port-filter/whitelist.conf

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -l /etc/port-filter/whitelist.conf

# é‡æ–°åŠ è½½ç™½åå•
load_whitelist_from_file
```

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹å½“å‰ç™½åå•IPSetå†…å®¹
ipset list whitelist

# æŸ¥çœ‹IPv6ç™½åå•ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
ipset list whitelist6

# æµ‹è¯•IPæ˜¯å¦åœ¨ç™½åå•ä¸­
ipset test whitelist 192.168.1.100

# æŸ¥çœ‹ç™½åå•è§„åˆ™ç»Ÿè®¡
iptables -L INPUT -n -v | grep whitelist
```

## æœ€ä½³å®žè·µ

### ç™½åå•ç®¡ç†å»ºè®®
1. **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ç™½åå•ï¼Œç§»é™¤ä¸å†éœ€è¦çš„IP
2. **æœ€å°æƒé™**ï¼šåªæ·»åŠ å¿…è¦çš„IPåˆ°ç™½åå•
3. **åˆ†ç±»ç®¡ç†**ï¼šä¸ºä¸åŒç±»åž‹çš„IPæ·»åŠ æ¸…æ™°çš„å¤‡æ³¨
4. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½ç™½åå•é…ç½®
5. **ç›‘æŽ§å®¡è®¡**ï¼šç›‘æŽ§ç™½åå•IPçš„è®¿é—®æƒ…å†µ

### å®‰å…¨å»ºè®®
1. **è°¨æ…Žæ·»åŠ **ï¼šä»”ç»†éªŒè¯éœ€è¦æ·»åŠ åˆ°ç™½åå•çš„IP
2. **é™åˆ¶èŒƒå›´**ï¼šå°½é‡ä½¿ç”¨å…·ä½“çš„IPåœ°å€è€Œéžå¤§çš„IPæ®µ
3. **å®šæœŸæ›´æ–°**ï¼šåŠæ—¶æ›´æ–°ç™½åå•ï¼Œç§»é™¤è¿‡æœŸIP
4. **è®¿é—®æŽ§åˆ¶**ï¼šç™½åå•ä¸èƒ½æ›¿ä»£å…¶ä»–å®‰å…¨æŽªæ–½
5. **ç›‘æŽ§å¼‚å¸¸**ï¼šç›‘æŽ§ç™½åå•IPçš„å¼‚å¸¸è¡Œä¸º

### æ€§èƒ½ä¼˜åŒ–
1. **åˆç†è§„åˆ’**ï¼šé¿å…æ·»åŠ è¿‡å¤šç™½åå•IP
2. **IPæ®µä¼˜åŒ–**ï¼šä½¿ç”¨IPæ®µä»£æ›¿å¤šä¸ªå•ç‹¬IP
3. **å®šæœŸæ¸…ç†**ï¼šæ¸…ç†ä¸å†ä½¿ç”¨çš„ç™½åå•IP
4. **ç›‘æŽ§æ€§èƒ½**ï¼šç›‘æŽ§ç™½åå•å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“

## ç‰ˆæœ¬ä¿¡æ¯

### å½“å‰ç‰ˆæœ¬ï¼šv2.2.0
- âœ… IPç™½åå•åŠŸèƒ½
- âœ… æ”¯æŒIPv4/IPv6
- âœ… æ”¯æŒIPæ®µç™½åå•
- âœ… ç™½åå•ä¼˜å…ˆçº§æŽ§åˆ¶
- âœ… æ‰¹é‡å¯¼å…¥åŠŸèƒ½
- âœ… æŒä¹…åŒ–å­˜å‚¨
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

### æ›´æ–°æ—¥å¿—
- **v2.2.0**: å¢žåŠ IPç™½åå•åŠŸèƒ½
- **v2.1.0**: ç³»ç»Ÿç›‘æŽ§å’Œå¤‡ä»½åŠŸèƒ½
- **v2.0.0**: åŸºç¡€ç«¯å£è¿‡æ»¤åŠŸèƒ½

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- GitHub Issues
- æŠ€æœ¯ç¤¾åŒºè®¨è®º
- é‚®ä»¶åé¦ˆ

---

**é‡è¦æé†’**ï¼š
1. ä½¿ç”¨ç™½åå•åŠŸèƒ½å‰è¯·å……åˆ†æµ‹è¯•
2. å»ºè®®å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
3. é‡è¦IPæ·»åŠ åˆ°ç™½åå•å‰è¯·åŒé‡ç¡®è®¤
4. å®šæœŸæ£€æŸ¥ç™½åå•é…ç½®çš„æœ‰æ•ˆæ€§